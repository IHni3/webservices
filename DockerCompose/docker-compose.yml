version: "3"

services:
  stocksdb:
    image: postgres:latest
    environment:
      POSTGRES_DB: stocks
      POSTGRES_USER: stock
      POSTGRES_PASSWORD: password
    volumes:
      - ./iddb_init.sql:/docker-entrypoint-initdb.d/init.sql

  iddb:
    image: postgres:latest
    environment:
      POSTGRES_DB: iddb
      POSTGRES_USER: iddb
      POSTGRES_PASSWORD: password
    volumes:
      - ./iddb_init.sql:/docker-entrypoint-initdb.d/init.sql

  cachedb:
    image: postgres:latest
    environment:
      POSTGRES_DB: cachedb
      POSTGRES_USER: cachedb
      POSTGRES_PASSWORD: password
    volumes:
      - ./cachedb_init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"

  idmgmt:
    build: ../IdentityManagement
    environment:
      ASPNETCORE_URLS: "https://+:443;http://+:80"
      ASPNETCORE_Kestrel__Certificates__Default__Password: "password"
      ASPNETCORE_Kestrel__Certificates__Default__Path: /app/certs/idmgmt.pfx
    depends_on:
      - iddb


  stocks:
    build: ../stocks-webservice
    depends_on: 
      - stocksdb
      - idmgmt

  hostess:
    image: nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./cert.crt:/etc/nginx/cert.crt:ro
      - ./cert.rsa:/etc/nginx/cert.key:ro
    depends_on:
      - idmgmt
      - stocks
    ports:
      - "4000:4000"
      - "4001:4001"

networks:
  default:
    driver: bridge
